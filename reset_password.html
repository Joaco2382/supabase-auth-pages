<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ¡Asegúrate de que tus credenciales estén aquí!
    const SUPABASE_URL = 'https://xlhiudracgwmolfazqvn.supabase.co'; // TU URL REAL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsaGl1ZHJhY2d3bW9sZmF6cXZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNTY4MjcsImV4cCI6MjA3MzczMjgyN30.5Qm-6gYkcKs1cK5xt3YqxFSsnfMkd1QXosu2GQIN1H4'; // TU KEY REAL
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const DEEP_LINK = "anfitrionhubmallplaza://password-reset-success";
    const statusMessageEl = document.getElementById('statusMessage');
    const passwordFormEl = document.getElementById('passwordForm');
    
    // --- Lógica de Manejo de Éxito y Deep Link ---
    function handleSuccess() {
        statusMessageEl.innerText = '¡Contraseña cambiada exitosamente!';
        statusMessageEl.className = 'success';
        passwordFormEl.style.display = 'none';

        window.location.href = DEEP_LINK;
        
        setTimeout(() => {
            if (window.opener) {
                window.close(); 
            } else {
                statusMessageEl.innerText += ' (Puedes cerrar esta ventana)';
            }
        }, 5000);
    }

    // --- Lógica de Verificación de Sesión y Formulario (CORRECCIÓN) ---
    async function handleRecoveryLink() {
        const urlParams = new URLSearchParams(window.location.hash.replace('#', '?'));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');

        if (accessToken && refreshToken) {
            // Intenta establecer la sesión con los tokens de la URL.
            const { error: sessionError } = await supabase.auth.setSession({ 
                access_token: accessToken,
                refresh_token: refreshToken 
            });

            if (!sessionError) {
                // Si la sesión se establece, muestra el formulario.
                statusMessageEl.innerText = '¡Enlace válido! Ingresa tu nueva contraseña.';
                statusMessageEl.className = 'success';
                passwordFormEl.style.display = 'block';
                return; // Detener la ejecución
            }
        }
        
        // Si no hay tokens o falló la verificación:
        statusMessageEl.innerText = 'Enlace de restablecimiento inválido o expirado. Intenta de nuevo.';
        statusMessageEl.className = 'error';
        passwordFormEl.style.display = 'none';
        
        // Opcional: Redirigir al inicio después de un tiempo si falla.
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 3000);
    }
    
    // --- Lógica de Actualización de Contraseña ---
    async function updatePassword() {
        const newPassword = document.getElementById('newPassword').value;
        if (newPassword.length < 6) {
            statusMessageEl.innerText = 'La contraseña debe tener al menos 6 caracteres.';
            statusMessageEl.className = 'error';
            return;
        }

        statusMessageEl.innerText = 'Cambiando contraseña...';
        statusMessageEl.className = '';
        
        const { error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) {
            statusMessageEl.innerText = 'Error al cambiar la contraseña: ' + error.message;
            statusMessageEl.className = 'error';
        } else {
            handleSuccess();
        }
    }
    
    // ¡Ejecuta la lógica de manejo del enlace al cargar la página!
    handleRecoveryLink(); 

</script>